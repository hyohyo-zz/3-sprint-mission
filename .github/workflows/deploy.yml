name: CD - Deploy to AWS ECS

on:
  push:
    branches: [ release ]

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  ECR_REPOSITORY_URI: ${{ vars.ECR_REPOSITORY_URI }}
  ECS_CLUSTER: ${{ vars.ECS_CLUSTER }}
  ECS_SERVICE: ${{ vars.ECS_SERVICE }}
  ECS_TASK_DEFINITION: ${{ vars.ECS_TASK_DEFINITION }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image-uri: ${{ steps.build.outputs.image-uri }}
      commit-sha: ${{ steps.meta.outputs.commit-sha }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials for ECR
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: us-east-1  # Public ECRì€ us-east-1ì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥

      - name: Login to Amazon ECR Public
        id: login-ecr-public
        run: |
          aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws

      - name: Extract metadata and prepare tags
        id: meta
        run: |
          COMMIT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "commit-sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "image-latest=${{ env.ECR_REPOSITORY_URI }}:latest" >> $GITHUB_OUTPUT
          echo "image-commit=${{ env.ECR_REPOSITORY_URI }}:${COMMIT_SHA}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        id: build
        run: |
          # Docker ì´ë¯¸ì§€ ë¹Œë“œ (ë‹¨ì¼ í”Œë«í¼: linux/amd64)
          docker build -t ${{ steps.meta.outputs.image-latest }} .
          docker tag ${{ steps.meta.outputs.image-latest }} ${{ steps.meta.outputs.image-commit }}
          
          # ECRì— í‘¸ì‹œ
          docker push ${{ steps.meta.outputs.image-latest }}
          docker push ${{ steps.meta.outputs.image-commit }}
          
          # ì¶œë ¥ ì„¤ì •
          echo "image-uri=${{ steps.meta.outputs.image-latest }}" >> $GITHUB_OUTPUT
          
          echo "ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ ì™„ë£Œ:"
          echo "  - ${{ steps.meta.outputs.image-latest }}"
          echo "  - ${{ steps.meta.outputs.image-commit }}"

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials for ECS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ${{ env.AWS_REGION }}  # ECS í´ëŸ¬ìŠ¤í„° ì ‘ê·¼ìš© ë¦¬ì „

      - name: Download current task definition
        run: |
          aws ecs describe-task-definition \
            --task-definition ${{ env.ECS_TASK_DEFINITION }} \
            > task-definition.json
          
          echo "í˜„ì¬ íƒœìŠ¤í¬ ì •ì˜ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"

      - name: Update task definition with new image
        run: |
          echo "íƒœìŠ¤í¬ ì •ì˜ì— ìƒˆ ì´ë¯¸ì§€ ì ìš©..."
          
          # ìƒˆ ì´ë¯¸ì§€ URIë¡œ íƒœìŠ¤í¬ ì •ì˜ ì—…ë°ì´íŠ¸
          NEW_IMAGE_URI="${{ needs.build-and-push.outputs.image-uri }}"
          
          # ê¸°ì¡´ íƒœìŠ¤í¬ ì •ì˜ë¥¼ ê°€ì ¸ì˜¤ë˜, ê¼­ í•„ìš”í•œ í•„ë“œë§Œ ì¶”ì¶œ
          jq \
            --arg IMAGE "$NEW_IMAGE_URI" \
            '.taskDefinition
            | {
                family,
                taskRoleArn,
                executionRoleArn,
                networkMode,
                containerDefinitions,
                volumes,
                placementConstraints,
                requiresCompatibilities,
                cpu,
                memory
              }
            | .containerDefinitions[0].image = $IMAGE' \
            task-definition.json > updated-task-definition.json
          
          # ìƒˆ íƒœìŠ¤í¬ ì •ì˜ ë“±ë¡
          NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://updated-task-definition.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          
          echo "NEW_TASK_DEFINITION_ARN=${NEW_TASK_DEF_ARN}" >> $GITHUB_ENV
          echo "ìƒˆ íƒœìŠ¤í¬ ì •ì˜ ë“±ë¡ ì™„ë£Œ: ${NEW_TASK_DEF_ARN}"

      - name: Stop current ECS service (í”„ë¦¬í‹°ì–´ ê³ ë ¤)
        run: |
          echo "â¹í˜„ì¬ ECS ì„œë¹„ìŠ¤ ì¤‘ë‹¨ (í”„ë¦¬í‹°ì–´ ë¦¬ì†ŒìŠ¤ ê³ ë ¤)..."
          
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE }} \
            --desired-count 0
          
          echo "íƒœìŠ¤í¬ ì™„ì „ ì¤‘ë‹¨ ëŒ€ê¸° ì¤‘..."
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }}
          
          echo "ê¸°ì¡´ ì„œë¹„ìŠ¤ ì¤‘ë‹¨ ì™„ë£Œ"

      - name: Deploy updated task definition to ECS
        run: |
          echo "ìƒˆ íƒœìŠ¤í¬ ì •ì˜ë¡œ ECS ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸..."
          
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE }} \
            --task-definition ${{ env.NEW_TASK_DEFINITION_ARN }} \
            --desired-count 1
          
          echo "ì„œë¹„ìŠ¤ ì•ˆì •í™” ëŒ€ê¸° ì¤‘..."
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }}
          
          echo "ECS ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ ì™„ë£Œ"

      - name: Deployment notification
        if: success()
        run: |
          echo "ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo ""
          echo "ë°°í¬ëœ ì´ë¯¸ì§€:"
          echo "  - URI: ${{ needs.build-and-push.outputs.image-uri }}"
          echo "  - Commit: ${{ needs.build-and-push.outputs.commit-sha }}"
          echo ""
          echo "AWS ë¦¬ì†ŒìŠ¤:"
          echo "  - ECS í´ëŸ¬ìŠ¤í„°: ${{ env.ECS_CLUSTER }}"
          echo "  - ECS ì„œë¹„ìŠ¤: ${{ env.ECS_SERVICE }}"
          echo "  - íƒœìŠ¤í¬ ì •ì˜: ${{ env.NEW_TASK_DEFINITION_ARN }}"
          echo ""
          echo "ğŸ”— AWS ì½˜ì†”ì—ì„œ í™•ì¸:"
          echo "  - https://console.aws.amazon.com/ecs/home?region=${{ env.AWS_REGION }}#/clusters/${{ env.ECS_CLUSTER }}/services"

      - name: Deployment failure notification
        if: failure()
        run: |
          echo "ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
          echo "AWS ì½˜ì†”ì—ì„œ ECS ì„œë¹„ìŠ¤ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."